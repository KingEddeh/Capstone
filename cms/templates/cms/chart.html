{% extends "cms/base.html" %}
{% block title %}Data Analytics{% endblock title %}
{% block content %}
<div class="container">
    <div class="row">
        <!-- Chart col -->
        <div class="col-6">
            <!-- Patient Visits -->
            <div class="card card-body">
                <h5 class="card-title">Patient Visits<span> | Drag to Zoom In</span></h5>
                <div class="d-flex">
                    <button id="hours-24" class="btn btn-primary me-2">24H</button>
                    <button id="week-1" class="btn btn-primary me-2">1W</button>
                    <button id="month-1" class="btn btn-primary me-2">1M</button>
                    <button id="year-1" class="btn btn-primary">1Y</button>
                </div>
                <div id="chart"></div>
                
                <script>
                    let chart;
                    const now = new Date();
                    let allTimeStart, allTimeEnd;
                    
                    function resetCssClasses(e) {
                        const buttons = document.querySelectorAll('.btn-primary');
                        buttons.forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                    }

                    function setupEventListeners() {
                        document.querySelector('#hours-24').addEventListener('click', function(e) {
                            resetCssClasses(e);
                            const end = new Date().getTime();
                            const start = end - 24 * 60 * 60 * 1000;
                            console.log('24 hours - start:', new Date(start), 'end:', new Date(end));
                            chart.zoomX(start, end);
                        });

                        document.querySelector('#week-1').addEventListener('click', function(e) {
                            resetCssClasses(e);
                            const end = new Date().getTime();
                            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7).setHours(0, 0, 0, 0);
                            console.log('1 week - start:', new Date(start), 'end:', new Date(end));
                            chart.zoomX(start, end);
                        });

                        document.querySelector('#month-1').addEventListener('click', function(e) {
                            resetCssClasses(e);
                            const start = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0).getTime();
                            console.log('1 month - start:', new Date(start), 'end:', new Date(end));
                            chart.zoomX(start, end);
                        });

                        document.querySelector('#year-1').addEventListener('click', function(e) {
                            resetCssClasses(e);
                            const start = new Date(now.getFullYear(), 0, 1).getTime();
                            const end = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999).getTime();
                            console.log('1 year - start:', new Date(start), 'end:', new Date(end));
                            chart.zoomX(start, end);
                        });

                        document.querySelector('#all-time').addEventListener('click', function(e) {
                            resetCssClasses(e);
                            console.log('All time - start:', new Date(allTimeStart), 'end:', new Date(allTimeEnd));
                            chart.zoomX(allTimeStart, allTimeEnd);
                        });
                    }

                    document.addEventListener('DOMContentLoaded', function() {
                        fetch(`/api/logbooks/`)
                            .then(response => response.json())
                            .then(data => {
                                console.log('Response data:', data);
                                let seriesData = data[0];
                                
                                // Calculate all-time range
                                allTimeStart = Math.min(...seriesData.data.map(point => point[0]));
                                allTimeEnd = Math.max(...seriesData.data.map(point => point[0]));
                                
                                var options = {
                                    series: [seriesData],
                                    chart: {
                                        type: 'line',
                                        height: 350,
                                        zoom: {
                                            enabled: true,
                                            type: 'x',
                                            autoScaleYaxis: true
                                        },
                                        toolbar: {
                                            autoSelected: 'zoom',
                                            tools: {
                                                reset: true
                                            }
                                        }
                                    },
                                    xaxis: {
                                        type: 'datetime',
                                        labels: {
                                            format: 'MMM-dd-yyyy HH:mm',
                                            datetimeUTC: false
                                        },
                                        tickAmount: 6
                                    },
                                    yaxis: {
                                        title: {
                                            text: 'Records'
                                        },
                                        min: 1,
                                        tickAmount: 2,
                                        forceNiceScale: true
                                    },
                                    tooltip: {
                                        x: {
                                            format: 'MMM-dd-yyyy'
                                        }
                                    },
                                    dataLabels: {
                                        enabled: false
                                    },
                                    markers: {
                                        size: 5
                                    }
                                };
                                chart = new ApexCharts(document.querySelector("#chart"), options);
                                chart.render().then(() => {
                                    setupEventListeners();
                                });
                            })
                            .catch(error => console.error('Error fetching data:', error));
                    });
                </script>
            </div>
        </div>
        <!-- chart col end-->
    </div>
</div>
{% endblock content %}