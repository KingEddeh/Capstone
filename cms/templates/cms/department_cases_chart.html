{% extends "cms/base.html" %}
{% block title %}Department Cases Analytics{% endblock title %}
{% block content %}
<div class="container">
  <div class="row">
    <div class="pagetitle">
      <h1>Department Cases Analytics</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'Dashboard'%}">Dashboard</a></li>
          <li class="breadcrumb-item active">Department Cases Analytics</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->
    <!-- Department Cases Chart -->
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title">Department Cases by Category</h2>
          <form id="filter-form" class="mb-4">
            <div class="row">
              <div class="col-md-6">
                <label for="year-select" class="form-label">Select Year:</label>
                <select id="year-select" name="year" class="form-select">
                  {% for year in years %}
                    <option value="{{ year.year }}">{{ year.year }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="month-select" class="form-label">Select Month:</label>
                <select id="month-select" name="month" class="form-select">
                  {% for month_number, month_name in months %}
                    <option value="{{ month_number }}">{{ month_name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Generate Chart</button>
          </form>
         
          <div id="department-cases-chart"></div>
        </div>
      </div>
    </div>
    <!-- End Department Cases Chart -->
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  $(document).ready(function() {
    $('#filter-form').on('submit', function(e) {
      e.preventDefault();
      var formData = $(this).serialize();
      
      $.ajax({
        url: '{% url "department_cases_chart" %}',
        data: formData,
        dataType: 'json',
        success: function(data) {
          renderDepartmentCasesChart(data);
        },
        error: function(xhr, status, error) {
          console.error("An error occurred: " + error);
          alert("An error occurred while fetching data. Please try again.");
        }
      });
    });
  });
  
  function renderDepartmentCasesChart(data) {
    var series = [];
    var categories = [];
    
    // Prepare data for the chart
    for (var dept in data) {
      var deptData = [];
      for (var category in data[dept]) {
        if (!categories.includes(category)) {
          categories.push(category);
        }
        deptData.push(data[dept][category]);
      }
      series.push({
        name: dept,
        data: deptData
      });
    }
  
    var options = {
      series: series,
      chart: {
        type: 'bar',
        height: 600,
        stacked: true,
      },
      plotOptions: {
        bar: {
          horizontal: true,
        },
      },
      stroke: {
        width: 1,
        colors: ['#fff']
      },
      title: {
        text: 'Department Cases by Category'
      },
      xaxis: {
        categories: categories,
        labels: {
          formatter: function (val) {
            return val
          }
        }
      },
      yaxis: {
        title: {
          text: undefined
        },
      },
      tooltip: {
        y: {
          formatter: function (val) {
            return val
          }
        }
      },
      fill: {
        opacity: 1
      },
      legend: {
        position: 'top',
        horizontalAlign: 'left',
        offsetX: 40
      },
      dataLabels: {
        enabled: true,
        formatter: function (val, opt) {
          return opt.w.globals.seriesNames[opt.seriesIndex] + ": " + val;
        },
        style: {
          colors: ['#fff']
        }
      }
    };
  
    if (window.departmentCasesChart instanceof ApexCharts) {
      window.departmentCasesChart.destroy();
    }
    window.departmentCasesChart = new ApexCharts(document.querySelector("#department-cases-chart"), options);
    window.departmentCasesChart.render();
  }
</script>
{% endblock extra_js %}